# Feature Specification: Qeel - 量的トレーディング向けバックテストライブラリ

**Feature Branch**: `001-qeel-core`
**Created**: 2025-11-25
**Status**: Draft
**Input**: User description: "本プロジェクトのコア要件・仕様を定義します。バックテストから実運用へのシームレスな接続を可能とするバックテストライブラリを開発します。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - バックテストの実行と結果検証 (Priority: P1)

クオンツアナリストが、外部で検証済みのシグナル計算ロジックをバックテストループに組み込み、過去データを用いて戦略のパフォーマンスを評価する。

**Why this priority**: バックテスト機能はシステムのコア価値であり、これがなければ他の機能も意味を持たない。戦略の有効性を検証する最重要機能。

**Independent Test**: シグナル計算ロジックと市場データを用意し、バックテストを実行してリターン指標（シャープレシオ、最大ドローダウンなど）が算出されることで検証可能。

**Acceptance Scenarios**:

1. **Given** シグナル計算ロジックと過去の市場データ（OHLCV）が用意されている、**When** バックテストを実行する、**Then** 日次リターン、累積リターン、シャープレシオ、最大ドローダウンなどのパフォーマンス指標が算出される
2. **Given** 複数銘柄の市場データが用意されている、**When** ポートフォリオ戦略でバックテストを実行する、**Then** 銘柄ごと、およびポートフォリオ全体のパフォーマンス指標が算出される
3. **Given** コスト設定（手数料、スリッページ、マーケットインパクト）が設定で定義されている、**When** バックテストを実行する、**Then** コストを考慮したリターンが算出される

---

### User Story 2 - 実運用への転用 (Priority: P2)

クオンツアナリストが、バックテストで検証した戦略ロジックを、コードを変更することなく実運用環境に展開する。

**Why this priority**: システムの差別化要因であり、バックテストと実運用の完全な再現性を保証する。P1のバックテスト機能が動作した後に価値を発揮する。

**Independent Test**: バックテストで使用した同一のシグナル計算ロジックと執行ロジックを用い、当日を指定して単一iterationを実行し、実際の取引所API経由で注文が送信されることで検証可能。

**Acceptance Scenarios**:

1. **Given** バックテストで検証済みの戦略ロジックが存在する、**When** 実運用モードで当日を指定してiterationを実行する、**Then** 取引所APIを通じて実際の注文が送信される
2. **Given** バックテストと実運用で同一の市場データとコンテキスト（ポジション情報）が用意されている、**When** 同一日時でそれぞれ実行する、**Then** 生成される注文内容（銘柄、数量、価格）が完全に一致する
3. **Given** 実運用で注文が約定された、**When** 約定情報を取得する、**Then** 約定情報が共通フォーマットで保存され、パフォーマンス計算に利用できる

---

### User Story 3 - シグナル評価の分布評価 (Priority: P3)

クオンツアナリストが、シグナル計算ロジックを全期間のデータに対して一括実行し、シグナルの有効性をリターンとの順位相関係数で評価する。

**Why this priority**: 戦略開発の初期段階で有用だが、バックテストとは独立した分析機能。P1、P2が完成した後に追加することで、より効率的な戦略開発が可能になる。

**Independent Test**: シグナル計算ロジックとリターン計算ロジックを用意し、全期間のデータに対してシグナルを算出し、年次・パラメータ別の順位相関係数の分布が可視化されることで検証可能。

**Acceptance Scenarios**:

1. **Given** シグナル計算ロジックと複数のパラメータの組が設定されている、**When** 全期間のデータに対してシグナルを一括計算する、**Then** 各パラメータ組み合わせごとのシグナル系列が生成される
2. **Given** シグナル系列とリターン系列が用意されている、**When** 評価を実行する、**Then** シグナルとリターンの順位相関係数が計算される
3. **Given** 年次別・パラメータ別の順位相関係数が算出されている、**When** 可視化を実行する、**Then** 分布図が生成され、シグナルのロバスト性が評価できる

---

### User Story 4 - バックテストと実運用の乖離検証 (Priority: P3)

クオンツアナリストが、実運用の結果とバックテストの結果を比較し、想定外の乖離がないかを確認する。

**Why this priority**: 実運用開始後の品質保証に重要だが、P2の実運用機能が稼働した後に意味を持つ。

**Independent Test**: 実運用の約定情報とバックテスト結果を用意し、同一期間のリターンを比較して差分が可視化されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 実運用の約定情報とバックテスト結果が同一期間で存在する、**When** 乖離可視化を実行する、**Then** 日次リターンの差分、累積リターンの差分がグラフで表示される
2. **Given** 乖離が発見された、**When** 詳細ログを確認する、**Then** 乖離の原因（スリッページ、約定タイミング、データ品質など）を特定できる情報が提供される

---

### Edge Cases

- **データ欠損**: データソースに欠損値が含まれる場合、システムはそのまま処理を継続する。ユーザは必要に応じて、シグナル計算ロジック内で欠損処理を実装する
- **異常値**: 価格がゼロまたは異常に高い値の場合、システムは検出せず、ユーザがシグナル計算ロジック内で異常値検出とフィルタリングを実装する責任を持つ
- **設定バリデーション**: 設定ファイルが不正な形式、矛盾した設定、または必須パラメータの欠落を含む場合、システムは起動前に厳密にバリデーションし、具体的なエラーメッセージ（不正な項目名、型不一致、矛盾箇所）を出力して停止する
- **銘柄ユニバースの動的決定**: 複数銘柄のバックテストでは、各iterationにおいて当日にデータが存在する銘柄のみを自然にユニバース（対象銘柄群）とする。一部の銘柄のデータが不足している場合でも、警告を出さず、データが存在する銘柄のみで処理を継続する

## Requirements *(mandatory)*

### Functional Requirements

#### バックテスト実行

- **FR-001**: システムは、固定幅（日足、週足、時間足など）でのiterationベースのバックテストループを提供しなければならない
- **FR-002**: システムは、各iterationで複数のデータソース（OHLCV、決算情報など）を任意のwindowサイズで取得できなければならない
- **FR-003**: システムは、各データソースが実際に利用可能な日時を厳密に管理し、リーク防止のために過去データのみを参照しなければならない
- **FR-004**: システムは、iteration内で以下のステップを分離して実装できなければならない：
  - シグナル計算: ユーザがカスタムロジックを実装可能。複数のデータソースを入力として受け取り、シグナルを出力
  - ポートフォリオ構築: ユーザがカスタムロジックを実装可能。シグナルを入力として受け取り、ポートフォリオ計画を出力。出力には執行条件計算に必要なメタデータ（シグナル強度、優先度、タグ等）を含められる。デフォルト実装（シグナル上位N銘柄選定）を提供
  - 執行条件計算: ユーザがカスタムロジックを実装可能。ポートフォリオ計画（メタデータ含む）、現在のポジション、価格データを入力として受け取り、注文を生成。メタデータを活用して柔軟な注文生成が可能。デフォルト実装（等ウェイトポートフォリオ、成行注文）を提供
  - 執行: 生成された注文を実行
  - 約定情報取得: 約定結果を取得
  - パフォーマンス計算: 約定情報からパフォーマンス指標を計算
- **FR-005**: システムは、各ステップの入出力データをスキーマ定義し、実行時にバリデーションを行わなければならない。特に以下のデータ構造は厳密に管理される：
  - シグナル計算ロジックのパラメータ
  - 各ステップの入力データ（市場データ、ポジション、注文等）
  - 各ステップの出力データ（シグナル、注文、約定情報等）
  - コンテキスト情報（ポジション、シグナル、ポートフォリオ計画等）
- **FR-006**: システムは、ポジション情報、選択銘柄、シグナルなどのコンテキストを各iteration間で永続化し、次のiterationで参照できなければならない
- **FR-007**: システムは、コスト（手数料、スリッページ、マーケットインパクト）を設定から読み込み、リターン計算に反映しなければならない
- **FR-008**: システムは、複数銘柄の同時トレードに対応しなければならない
- **FR-009**: システムは、各iterationにおいて、当日にデータが存在する銘柄のみをユニバース（対象銘柄群）として自動的に決定しなければならない。一部の銘柄のデータが不足している場合でも、警告を出さず、データが存在する銘柄のみで処理を継続しなければならない
- **FR-010**: システムは、設定によってバックテスト対象銘柄のリストを明示的に指定できなければならない。

#### 実運用への転用

- **FR-011**: システムは、バックテストで使用したシグナル計算ロジックを、コード変更なしで実運用に転用できなければならない
- **FR-012**: システムは、実運用時に当日を指定して単一iterationを実行し、バックテストと完全な再現性を保証しなければならない
- **FR-013**: システムは、実運用時の執行ロジックと約定情報取得ロジックを、ユーザが取引所APIなどに応じてカスタム実装できる拡張ポイントを提供しなければならない
- **FR-014**: システムは、バックテスト時にモックで約定をシミュレートし、実運用時に実際の取引所APIに差し替え可能でなければならない。数量・価格の最小単位丸めは、バックテスト時のモックではスキップし、実運用時の取引所API層で取引所の仕様に応じて実施する
- **FR-015**: システムは、実運用の約定情報を共通フォーマットで保存し、バックテストと同一のパフォーマンス計算ロジックを適用できなければならない

#### シグナル評価

- **FR-016**: システムは、シグナル計算ロジックに対して複数の可能なパラメータの組を設定し、全期間のデータに対して一括でシグナルを計算できなければならない
- **FR-017**: システムは、リターン計算ロジックをユーザが実装可能にしなければならない。リターンは、現在日時で生成されたシグナルに対する未来の実現リターンを表し、リーク（ルックアヘッドバイアス）防止のため、過去データを使用してはならない。この計算結果をシグナルと結合して順位相関係数を評価できなければならない
- **FR-018**: システムは、年次別・パラメータ別の順位相関係数を計算し、分布として可視化できなければならない

#### データ管理

- **FR-019**: システムは、各データソースのパラメータ（日時列名、利用可能時刻のオフセット、提供window）を設定で管理しなければならない
- **FR-020**: システムは、データソースの読み込み元をユーザが柔軟に定義できるインターフェースを提供しなければならない（標準ファイル形式、データベース、外部APIなど）
- **FR-021**: システムは、データソースに欠損値が含まれる場合、そのまま処理を継続しなければならない。欠損値処理は、ユーザがシグナル計算ロジック内で実装する責任を持つ

#### コンテキスト管理

- **FR-022**: システムは、iteration内の各ステップの出力（シグナル、ポートフォリオ計画、注文）を個別に日付ごとにパーティショニングして保存しなければならない。ポジション情報は取引所APIから動的に取得されるため保存対象外。年月でディレクトリ分割し、トレーサビリティを確保する。読み込み時は、最新日付または指定日付の各要素を復元し、ポジションは取引所APIから取得してコンテキストを構築できなければならない
- **FR-023**: システムは、設定で指定されたストレージタイプ（ローカル/クラウドストレージ）に基づき、自動的にコンテキストの保存先を判断しなければならない

#### 結果分析と可視化

- **FR-024**: システムは、約定情報から共通のパフォーマンス指標（シャープレシオ、最大ドローダウン、勝率、日次リターンなど）を計算できなければならない
- **FR-025**: システムは、バックテスト結果と実運用結果の乖離を可視化できなければならない
- **FR-026**: システムは、期間を指定してバックテスト・実運用問わず共通のレポート出力ができなければならない

#### 設定管理

- **FR-027**: システムは、全体設定（ストレージタイプ、クラウドストレージ設定）、データソースの定義、コストパラメータ、ループ管理設定を設定ファイルで管理しなければならない。全体設定は、データソースやコンテキストの保存参照先の情報を含む
- **FR-028**: システムは、各ステップ（シグナル計算、銘柄選定、執行など）が呼ばれるタイミングを、ループ日付からのオフセットとして設定で定義できなければならない
- **FR-029**: システムは、起動前に設定ファイルを厳密にバリデーションし、不正な形式、型不一致、矛盾した設定、必須パラメータの欠落が検出された場合、具体的なエラーメッセージ（不正な項目名、期待される型、矛盾箇所）を出力して停止しなければならない

#### 取引日判定

- **FR-030**: システムは、取引日を判定するロジックを提供し、非取引日をスキップできなければならない

#### 実運用支援機能

- **FR-031**: システムは、実運用時の取引所クライアント実装を支援するため、ユーティリティ機能を提供しなければならない。ユーザはこれらを自由に利用可能だが、利用は強制ではない
  - APIリトライ（exponential backoff、タイムアウト）
  - エラー通知（Slack等）
  - 数量・価格の丸め処理

#### ワークスペース管理

- **FR-032**: システムは、環境変数でワークスペースディレクトリを指定可能でなければならない。未設定時はカレントディレクトリを参照する。ワークスペース配下には設定、入力データ、出力データのディレクトリが配置される
- **FR-033**: システムは、初期化コマンドを提供し、ワークスペース構造と設定ファイルテンプレートを自動生成できなければならない

#### ストレージ抽象化

- **FR-034**: システムは、ファイル読み書きを抽象化するストレージ層を提供しなければならない。ストレージ層は以下の責務を持つ:
  - 全体設定からストレージタイプを読み取り、適切な実装（ローカル/クラウド）を返す
  - ワークスペースまたはクラウドストレージからのベースパス取得
  - 年月パーティショニングディレクトリの生成
  - json, データフレームparquetに対応したデータの保存・読み込みメソッド（ベースパスからの相対パス指定）

### Key Entities

- **Market Data（市場データ）**: データソースから取得される各種データの総称。OHLCV価格データ、決算情報、ニュースデータなど、戦略に必要なあらゆるデータを含む。datetime列を含み、データが実際に利用可能な時刻を決定できる。複数のデータソースが存在し、それぞれ異なるwindowで提供される
- **Signal（シグナル）**: 各銘柄に対する定量的な特徴量または予測値。シグナル計算ロジックから生成され、銘柄選定の基礎となる。複数シグナル列（momentum, value等）を柔軟に扱える
- **Portfolio Plan**: ポートフォリオ構築計画。シグナルから計算された選択銘柄とメタデータ（シグナル強度、優先度、タグ等）を含む。執行条件計算の入力となる
- **Order（注文）**: 執行する注文の詳細（銘柄、売買区分、数量、価格、注文タイプなど）。ポートフォリオ計画、現在のポジション、価格データから計算され、執行ステップで実行される
- **Position（ポジション）**: 現在保有している銘柄と数量。各iterationで参照され、執行条件計算、ポートフォリオ計画計算の入力となる
- **Fill Report（約定情報）**: 注文が約定した結果の詳細（注文ID、銘柄、売買区分、数量、価格、手数料、タイムスタンプ）。パフォーマンス計算の入力となる
- **Context（コンテキスト）**: iterationをまたいで保持される状態（現在日時、シグナル、ポートフォリオ計画、注文、ポジション情報など）。各ステップが参照・更新し、永続化される
- **Metrics（パフォーマンス指標）**: リターン、シャープレシオ、最大ドローダウンなど、戦略の成績を表す指標。約定情報から計算される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: バックテストから実運用への転用時に、同一日時・同一データでiterationを実行した場合、生成される注文内容（銘柄、数量、価格）が100%一致する
- **SC-002**: シグナル計算ロジックを外部で検証した後、コードを変更せずにバックテストループに組み込み、1回の実行で期待通りのパフォーマンス指標が算出される
- **SC-003**: データソース追加時、設定の追加のみでシステムがそのデータを認識し、指定windowで取得できる（コード変更不要）
- **SC-004**: 実運用時の約定情報とバックテスト結果を比較した際、乖離の原因が特定できる詳細情報が提供される
- **SC-005**: パラメータ評価において、複数のパラメータの組に対して順位相関係数の分布が可視化され、オーバーフィットの有無を判断できる
- **SC-006**: データ欠損や設定エラーが発生した場合、システムは適切なエラーメッセージを出力し、復旧可能な状態を保つ

## Dependencies & Assumptions

### Dependencies

- **データ提供**: ユーザが市場データ（OHLCV、決算情報など）を標準ファイル形式（推奨）またはカスタムデータソース（データベース、外部APIなど）で用意する必要がある
- **取引所API**: 実運用時には、取引所が提供するAPI（注文送信、約定情報取得）が利用可能であることが前提
- **ストレージ**: 実運用時のコンテキスト保存には、クラウドストレージやデータベースなどのストレージサービスが必要

### Assumptions

- **固定幅のみ**: イベントベースのトレード（例: ニュース発表時の即座のトレード）は対象外とし、固定幅（日足、週足、時間足）のみをサポートする
- **外部検証済み**: シグナル計算ロジックは、本システムの分析機能を活用して詳細に検証済みであることを前提とし、バックテストは最終確認として1度のみ実行する
- **データフレーム操作**: 市場データとシグナルは、列名とスキーマが厳密に定義されたテーブル形式で扱う
- **スキーマバリデーション**: すべてのデータ構造（パラメータ、入出力、コンテキスト）をスキーマ定義し、実行時のスキーマバリデーションを必須とする
- **ローカルインストール**: システムはパッケージとしてユーザのローカル環境にインストール可能な形式で提供される
- **コスト計算の簡略化**: マーケットインパクト、スリッページ、手数料は、設定で定義された固定値またはシンプルなモデルで計算することを前提とする（複雑な動的モデルは対象外）
- **シングルユーザ**: 最初の実装では、複数ユーザの同時アクセスや権限管理は対象外とする
- **リターン計算の標準化**: リターンは単純リターンまたは対数リターンを使用し、より複雑なリターン計算（例: リスク調整後リターン、ベンチマーク相対リターン）はユーザ側で拡張可能とする
- **エラーハンドリング**: 実運用時の取引所API呼び出しにおけるエラーハンドリング（リトライ、タイムアウト、レート制限対策、通知など）は、ユーザが取引所クライアント実装時に独自に実装する責任を持つ。システムはユーティリティ機能を提供するが、その利用はユーザの選択に委ねられる
- **バックテストと実運用の分離**: バックテストと実運用は通常、別々のスクリプトで実行される。ユーザはコード内でバックテスト用またはライブ用のエンジンを明示的にインスタンス化し、取引所クライアント、データソース等の依存を注入する（Dependency Injection）。同一スクリプトで設定ファイルのみでモードを切り替えたい場合、ユーザがファクトリー関数を実装可能

### Out of Scope

- **リアルタイムティック単位のトレード**: 固定幅（日足、週足、時間足）のみをサポートし、ティック単位のイベントベースのトレードは対象外
- **ポートフォリオ最適化**: ポートフォリオ最適化（例: 平均分散最適化、リスクパリティ）は、ユーザが銘柄選定ロジック内で独自に実装する想定
- **リスク管理**: VaR、CVaRなどの高度なリスク管理指標は、パフォーマンス計算の標準機能には含まない（ユーザ側で拡張可能）
- **マルチアセット対応**: 最初の実装では単一のアセットに焦点を当て、為替、先物、オプションなどのマルチアセット対応は将来の拡張とする
- **モード設定による自動切り替え**: システムは、設定や環境変数によるバックテスト/実運用の自動切り替え機構を提供しない。ユーザがコンストラクタで明示的にエンジンを選択する設計を採用し、依存関係の透明性とテスタビリティを優先する
